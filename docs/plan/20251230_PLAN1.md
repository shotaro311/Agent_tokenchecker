# プランニングドキュメント：Codex 複数アカウントの同時表示（.codex / .codex-owner / .codex-member）

## 共通ルール（必読）

- 共通ルールはリポジトリルートの `AGENTS.md` を参照: `../../AGENTS.md`

## 今回の追加ルール / 例外（差分だけを書く）

- 追加ルール: Codexは3アカウント（`~/.codex`, `~/.codex-owner`, `~/.codex-member`）の使用状況を同時表示できるようにする。
- 追加ルール: 3枠の**表示名**は設定から編集できるようにする（例: `Work` / `Personal` / `Client`）。
- 追加ルール: 3枠の**紐付けパス（CODEX_HOME）**は設定から編集できるようにする（例: `~/.codex-owner`）。
- 追加ルール: v1は「Codexアカウント＝追加の `UsageProvider`」として実装し、任意数アカウントの動的追加はスコープ外とする。
- 追加ルール: アカウント間で認証情報を混ぜない（Codex CLI/RPC起動時に `CODEX_HOME` を明示して分離する）。
- 例外: なし

## 実装モード（単独 / 並列）

- 実装モード: 単独
- 判定理由（要点だけ）:
  - `UsageProvider` 追加により `switch provider` の更新が多く、編集衝突しやすい
  - UI/CLI/Coreの境界をまたぐ変更になり、合流コストが高い

**作成日**: 2025-12-30
**バージョン**: 1.0
**ステータス**: 実装完了
**承認**: 2025-12-30（実装依頼あり）

---
# 進捗状況（他の開発者が見て続きの実装に取り掛かれるように、簡潔かつわかりやすく記載すること）

## ⚡ クイックリファレンス

**現在地**: Phase 3 - 完了（2025-12-31: コスト表示の反映修正・menuCardModel対応）
**次のアクション**: ユーザー動作確認（Providersで3枠を有効化し、表示名/パスとコスト表示を確認）
**ブロッカー**: なし
**重要な決定事項**: 「追加ルール」に記載のとおり

### フェーズ進捗
- [x] Phase 0: 仕様整理・影響範囲の洗い出し
- [x] Phase 1: Core取得経路を `CODEX_HOME` 対応
- [x] Phase 2: Provider/UI/設定を3アカウント化
- [x] Phase 3: テスト/動作確認/ドキュメント同期

### 重要なファイルパス
- Provider enum/metadata: `Sources/CodexBarCore/Providers/Providers.swift`
- Providerレジストリ: `Sources/CodexBar/ProviderRegistry.swift`
- Provider実装登録: `Sources/CodexBar/Providers/Shared/ProviderCatalog.swift`
- Codex使用量取得: `Sources/CodexBarCore/UsageFetcher.swift`
- Codex PTYプローブ: `Sources/CodexBarCore/Providers/Codex/CodexStatusProbe.swift`
- Codexログイン: `Sources/CodexBar/CodexLoginRunner.swift`
- ログインフロー: `Sources/CodexBar/Providers/Shared/ProviderLoginFlow.swift`
- Storeの `switch provider` 群: `Sources/CodexBar/UsageStore.swift`
- Providers設定UI: `Sources/CodexBar/PreferencesProvidersPane.swift`
- CLI（必要なら）: `Sources/CodexBarCLI/CLIEntry.swift`

### 検証
- `swift test`
- `pnpm check`
- `./Scripts/compile_and_run.sh`

---

## 要件概要

### 背景・目的

- 複数ターミナルで3つのCodexアカウントを使い分けて運用している（`CODEX_HOME` を切り替えている）。
- どのアカウントの枠（Session/Weekly）が残っているかをメニューバーで同時に把握したい。

### 実装する機能（v1）

- Codexを3枠（`~/.codex`, `~/.codex-owner`, `~/.codex-member`）として扱い、同時に使用量（Session/Weekly）を表示できる。
- 各枠の表示名を設定から編集でき、メニュー/設定画面の表示に反映される。
- 各枠の紐付けパス（`CODEX_HOME`）を設定から編集でき、以降の取得/ログインに反映される。
- 各枠は独立して `codex login` できる（= `CODEX_HOME` を指定してログイン）。
- 各枠は独立して使用量を取得する（RPC→PTYフォールバックの経路を維持しつつ、`CODEX_HOME` で分離）。
- 既存の `.codex` 1枠の挙動は維持（デフォルトは今まで通り）。

### 非対象（v1）

- 任意数のCodexアカウント追加（UIで増減できる）※将来検討
- OpenAI Webダッシュボード/クレジット/購入フローを3アカウント分表示
  - 現状 `provider == .codex` に限定されているため（まずは同時表示のコア要件を優先する）
- Claude等の他プロバイダのマルチアカウント対応

---

## 方針（設計）

### 採用案：`UsageProvider` を追加して最短で同時表示

- `UsageProvider` に `codexOwner`, `codexMember` を追加する（`codex` は既存のまま）。
- それぞれのProviderは、実行時に `CODEX_HOME` を上書きしてCodex CLI/RPCを起動する。
- 表示名は「metadataの既定値 + SettingsStoreの上書き」で決める。
- `CODEX_HOME` も「既定値 + SettingsStoreの上書き」で決める（空の場合は既定値）。
- パス入力は `~` を許可し、実行前に展開して使う（`~`→ホームディレクトリ）。

### 代替案（今回は採用しない）

- ProviderIDをenumから動的IDに拡張して「Codexアカウント一覧」を一般化する
  - 影響範囲が大きいのでv1対象外

---

## 実装ステップ（概要）

### Phase 1: Core取得経路を `CODEX_HOME` 対応

- `UsageFetcher` が保持している `environment` を、RPC/PTY実行にも反映するように修正する。
  - `CodexRPCClient` に環境（特に `CODEX_HOME`）を渡せるようにする
  - `CodexStatusProbe` に `environmentOverrides` を渡せるようにする（`TTYCommandRunner.Options.environmentOverrides` を利用）
- `CodexLoginRunner` に `environmentOverrides`（`CODEX_HOME`）を渡せるようにする。

### Phase 2: Provider/UI/設定を3アカウント化

- `Sources/CodexBarCore/Providers/Providers.swift` に新providerを追加し、metadata（`cliName` / `toggleTitle` / `displayName`）を追加する。
- `Sources/CodexBar/SettingsStore.swift` に「Codex 3枠の表示名」保存項目を追加する（UserDefaults永続化）。
- `Sources/CodexBar/SettingsStore.swift` に「Codex 3枠の紐付けパス（CODEX_HOME）」保存項目を追加する（UserDefaults永続化）。
- 設定画面の「プロバイダ」ペイン（`Sources/CodexBar/PreferencesProvidersPane.swift`）に表示名編集フィールドを追加する（`ProviderSettingsFieldDescriptor`）。
- 設定画面の「プロバイダ」ペイン（`Sources/CodexBar/PreferencesProvidersPane.swift`）に紐付けパス編集フィールドを追加する（`ProviderSettingsFieldDescriptor`）。
- メニュー/設定の表示名は、静的な `ProviderDefaults.metadata[*].displayName` ではなく、上書き反映後の名前を使うように統一する。
- `Sources/CodexBar/Providers/Shared/ProviderCatalog.swift` に新providerの `ProviderImplementation` を登録する。
- 新provider用の実装（例: `CodexOwnerProviderImplementation`）を追加し、`UsageFetcher(environment: ...)` で取得する。
- `Sources/CodexBar/Providers/Shared/ProviderLoginFlow.swift` を拡張し、新providerの「アカウント追加/切替」が `CODEX_HOME` 付きログインになるようにする。
- `Sources/CodexBar/UsageStore.swift` などの `switch provider` を新providerに対応する（version / icon / stale判定 ほか）。
- Providers設定画面で3枠が表示され、有効/無効が切り替えられることを確認する。

### Phase 3: テスト/検証

- `swift test` / `pnpm check`
- 可能なら `Tests/CodexBarTests` に軽いテストを追加する
  - 例: `UsageFetcher(environment:)` が `auth.json` を指定ディレクトリから読めること（※内容のログ出力はしない）
  - 例: Codex PTY/RPC 起動時に `CODEX_HOME` が渡っていること（モック/注入できる形なら）

---

## リスクと対応策

- **スイッチ網羅の破壊（コンパイルエラー）**: `UsageProvider` 追加後に `switch provider` を検索して確実に更新する。
- **アカウント混線**: Codex実行プロセスには必ず `CODEX_HOME` を明示し、共有キャッシュ/共有ストアを増やさない。
- **「更新中…」で固まる**: Codex RPCが応答しないケースに備えて、RPC読み取りにタイムアウトを設け、login-shell PATH 取得を待ってから実行する。
- **パス入力ミス**: 設定に入力されたパスが存在しない/読めない場合、エラーを明確に表示し、既定値に戻せるようにする（最小: エラー表示 + 手動修正）。
- **負荷（3アカウント分のRPC起動）**: まずは現状のrefresh周期のまま様子見し、必要なら後で並列化/間引き検討をする（v1では最小）。

---

## 完了条件

- メニューバーにCodexが3枠表示され、各枠でSession/Weeklyが更新される。
- Providers設定で各枠のON/OFFができる。
- Providers設定で各枠の表示名/紐付けパス（`CODEX_HOME`）が編集でき、表示と取得に反映される。
- 「アカウントを追加/切り替え」が枠ごとに独立して動く（紐付けパスを尊重）。
- `swift test` / `pnpm check` が成功する。
