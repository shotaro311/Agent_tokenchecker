# プランニングドキュメント：UI言語切替（英語/日本語）と日本語化

## 共通ルール（必読）

- 共通ルールはリポジトリルートの `AGENTS.md` を参照: `../../AGENTS.md`

## 今回の追加ルール / 例外（差分だけを書く）

- 追加ルール: 初期言語は日本語。UI/表示文言は英語/日本語を設定で切替可能にする。
- 追加ルール: ドキュメントはREADME/CHANGELOG/docs配下/サイトHTMLまで日本語化する。
- 追加ルール: ウィジェット設定（AppIntent項目名）は日本語固定。
- 追加ルール: 外部データは辞書置換で可能な範囲のみ日本語化する。
- 例外: なし

## 実装モード（単独 / 並列）

- 実装モード: 単独
- 判定理由（要点だけ）:
  - 分割の独立性（契約で切れる）: NG
  - 合流コスト（共有境界の多さ）: 高
  - 編集衝突（同じファイル/意思決定の奪い合い）: 高
- 境界ケース（迷う/判断が曖昧）: **単独を選ぶ（既定動作）**

**作成日**: 2025-12-27
**バージョン**: 1.0
**ステータス**: 承認済み
**前バージョンからの変更**: 新規作成
**承認**: 2025-12-27 by user

---
# 進捗状況（他の開発者が見て続きの実装に取り掛かれるように、簡潔かつわかりやすく記載すること。作業ごとに、毎回内容を更新すること）

## ⚡ クイックリファレンス

**現在地**: Phase 3 - テスト/動作確認/ドキュメント同期（80%完了）
**次のアクション**: テスト実行（`swift test` / `pnpm check` / `./Scripts/compile_and_run.sh`）
**ブロッカー**: `swift test` が TestsLinux の `Testing` モジュール不足で失敗、`pnpm check` が swiftformat/swiftlint 未導入で失敗、`compile_and_run.sh` が署名ID未設定でパッケージ失敗
**重要な決定事項**: 初期言語は日本語、英語/日本語切替、外部データは辞書置換、ドキュメントは全体日本語化、ウィジェット設定は日本語固定

### フェーズ進捗
- [x] Phase 0: 仕様整理・影響範囲の洗い出し
- [x] Phase 1: 言語設定の保存/伝播設計
- [x] Phase 2: UI文言の日本語化と切替対応
- [🔄] Phase 3: テスト/動作確認/ドキュメント同期

### 重要なファイルパス
- 設定ストア: `Sources/CodexBar/SettingsStore.swift`
- 設定UI: `Sources/CodexBar/PreferencesGeneralPane.swift`
- 設定タブ: `Sources/CodexBar/PreferencesView.swift`
- メニュー文言: `Sources/CodexBar/MenuDescriptor.swift`
- 表示フォーマット: `Sources/CodexBarCore/UsageFormatter.swift`
- ウィジェットUI: `Sources/CodexBarWidget/CodexBarWidgetViews.swift`
- ウィジェット設定: `Sources/CodexBarWidget/CodexBarWidgetProvider.swift`
- デバッグUI: `Sources/CodexBar/PreferencesDebugPane.swift`
- 外部データ翻訳: `Sources/CodexBarCore/ExternalTextLocalizer.swift`

---

## 要件概要

### 背景・目的
- UI/表示文言を日本語中心にし、設定で英語/日本語の切替ができるようにする。

### 実装する機能
- 設定画面に「言語」選択（日本語/English）を追加する。
- 言語選択を `UserDefaults` に保存し、起動時は日本語を初期値にする。
- 主要UI文言（メニューバー項目、設定画面、ステータス/使用量表示、通知文言など）をローカライズする。
- 日付/相対時刻/通貨などの表示が選択言語に合わせて見えるようにする。
- 外部データの表示も可能な範囲で日本語化する。
- ウィジェット設定画面（AppIntent項目名）は日本語固定で表示する。
- ドキュメントを日本語化する。

### スコープ外
- CLI出力/ログの翻訳。

---

## 技術選定

### 新規導入ライブラリ
- なし

### 既存ライブラリの活用
- SwiftUI / Foundation の `Locale` / `DateFormatter` / `RelativeDateTimeFormatter` を使用。

---

## アーキテクチャ設計

### 方針
- `AppLanguage`（英語/日本語）を追加し、`SettingsStore` に保持・永続化する。
- 文字列は「言語に応じたラベルを返すヘルパー（Localization）」経由で参照する。
- `UsageFormatter` などコア側の表示文言は「言語またはLocale」を引数で受け取れるようにする（必要箇所のみ）。

---

## 実装フェーズ

### Phase 0: 仕様整理・影響範囲の洗い出し
- [x] 画面/メニュー/通知/フォーマッタの英語文言を棚卸し
- [x] 日本語訳の作成方針（短く分かりやすい）を決める
- [x] `docs/requirement/requirements.md` 作成可否の確認（ユーザー承認が必要）
- [x] `docs/requirement/requirements.md` を作成/更新

### Phase 1: 言語設定の保存/伝播設計
- [x] `SettingsStore` に言語設定を追加し、`UserDefaults` に保存
- [x] 設定UI（General）に言語選択UIを追加
- [x] 変更時にUIへ即反映される流れを作る

### Phase 2: UI文言の日本語化と切替対応
- [x] メニュー表示（`MenuDescriptor`）の文言をローカライズ
- [x] 設定画面/各ペインの文言をローカライズ
- [x] `UsageFormatter` の表示文言を言語選択に連動
- [ ] 既存テストの期待値を言語に合わせて調整、必要なら新規テスト追加

### Phase 3: テスト/動作確認/ドキュメント同期
- [x] ドキュメントを日本語化（README/CHANGELOG/docs配下/サイトHTML）
- [ ] `swift test` を実行
- [ ] `pnpm check` を実行
- [ ] `./Scripts/compile_and_run.sh` を実行し、アプリで英語/日本語切替を確認
- [x] `docs/requirement/requirements.md` を更新（ユーザー承認後）

---

## リスクと対応策

- **翻訳漏れ**: 画面/メニュー/フォーマッタの棚卸しでリスト化し、差分確認する。
- **Locale依存の表示崩れ**: `Locale` を言語に合わせて切替し、日付/相対時刻のテストで確認する。
- **既存テストの破損**: 言語選択を明示してテストを固定する。

---

## 完了条件

### 機能要件
- [ ] 設定画面で日本語/Englishが切替できる。
- [ ] 初期言語が日本語になっている。
- [ ] UI/表示文言が選択言語に応じて切替される。

### 品質要件
- [ ] `swift test` が成功する。
- [ ] `pnpm check` が成功する。
- [ ] `./Scripts/compile_and_run.sh` 実行後、アプリが起動して切替が確認できる。

### ドキュメント
- [x] `docs/requirement/requirements.md` を最新化（ユーザー承認後）

---

## 🐛 トラブルシューティング・既知の問題

- `swift test`: `TestsLinux/PlatformGatingTests.swift` が `Testing` モジュール未導入で失敗
- `pnpm check`: `swiftformat` / `swiftlint` 未導入で失敗
- `./Scripts/compile_and_run.sh`: Developer ID証明書未設定でパッケージ失敗

---

## 参考リソース

- なし
